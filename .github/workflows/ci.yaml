# ============================================================
# ðŸ”¬ OSSS Continuous Integration
# ------------------------------------------------------------
# Validates the OSSS standard on every push and pull request.
#
# Checks:
#  - Unit tests pass
#  - All example instances validate
#  - All example results validate
#  - Conformance tests pass (must-pass/must-fail)
#  - Schemas are valid JSON Schema
#  - Registry files are valid
# ============================================================

name: ðŸ”¬ CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: ðŸ§ª Tests & Validation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # ------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Setup Node.js
      # ------------------------------------------------------------
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: osss-validator/package-lock.json

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # ------------------------------------------------------------
      - name: ðŸ“¦ Install dependencies
        run: |
          cd osss-validator
          npm ci

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Run unit tests
      # ------------------------------------------------------------
      - name: ðŸ§ª Run unit tests
        run: |
          cd osss-validator
          npm test

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Link CLI for integration tests
      # ------------------------------------------------------------
      - name: ðŸ”— Link CLI
        run: |
          cd osss-validator
          npm link

      # ------------------------------------------------------------
      # 6ï¸âƒ£ Validate all examples (instances)
      # ------------------------------------------------------------
      - name: ðŸ“‹ Validate all example instances
        run: |
          echo "ðŸ” Validating all example instances..."
          osss-validate bundle \
            --examples ./examples \
            --schemas ./schemas \
            --registry ./registry

      # ------------------------------------------------------------
      # 7ï¸âƒ£ Run conformance tests
      # ------------------------------------------------------------
      - name: âœ… Run conformance tests
        run: |
          echo "ðŸ” Running conformance tests..."
          osss-validate conformance \
            --conformance ./conformance \
            --schemas ./schemas \
            --registry ./registry

      # ------------------------------------------------------------
      # 8ï¸âƒ£ Validate schemas are valid JSON Schema
      # ------------------------------------------------------------
      - name: ðŸ“ Validate JSON Schemas
        run: |
          echo "ðŸ” Validating JSON Schema files..."
          npm install -g ajv-cli ajv-formats

          for schema in schemas/*.schema.json; do
            echo "  Checking: $schema"
            ajv compile -s "$schema" --strict=false 2>/dev/null || {
              echo "âŒ Invalid schema: $schema"
              exit 1
            }
          done
          echo "âœ… All schemas are valid"

      # ------------------------------------------------------------
      # 9ï¸âƒ£ Validate registry files
      # ------------------------------------------------------------
      - name: ðŸ“š Validate registry files
        run: |
          echo "ðŸ” Validating registry files..."

          # Check constraints.json is valid JSON
          if ! jq empty registry/constraints.json 2>/dev/null; then
            echo "âŒ registry/constraints.json is not valid JSON"
            exit 1
          fi

          # Check objectives.json is valid JSON
          if ! jq empty registry/objectives.json 2>/dev/null; then
            echo "âŒ registry/objectives.json is not valid JSON"
            exit 1
          fi

          # Count constraints and objectives
          CONSTRAINT_COUNT=$(jq '.constraints | length' registry/constraints.json)
          OBJECTIVE_COUNT=$(jq '.objectives | length' registry/objectives.json)

          echo "âœ… Registry valid: $CONSTRAINT_COUNT constraints, $OBJECTIVE_COUNT objectives"

      # ------------------------------------------------------------
      # ðŸ”Ÿ Summary
      # ------------------------------------------------------------
      - name: ðŸ“Š Summary
        run: |
          echo "============================================"
          echo "ðŸŽ‰ All checks passed!"
          echo "============================================"
          echo ""
          echo "Node.js version: ${{ matrix.node-version }}"
          echo ""

          # Count examples
          EXAMPLE_COUNT=$(find examples -name "osss-instance.json" | wc -l | tr -d ' ')
          echo "Examples validated: $EXAMPLE_COUNT"

          # Count conformance tests
          MUST_PASS=$(find conformance/must-pass -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
          MUST_FAIL=$(find conformance/must-fail -name "*.json" 2>/dev/null | wc -l | tr -d ' ')
          echo "Conformance tests: $MUST_PASS must-pass, $MUST_FAIL must-fail"

  # ============================================================
  # Lint job (optional - runs in parallel)
  # ============================================================
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: osss-validator/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: |
          cd osss-validator
          npm ci

      - name: ðŸ” Check JSON formatting
        run: |
          echo "ðŸ” Checking JSON file formatting..."

          # Check all JSON files are valid
          find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.git/*" | while read file; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON: $file"
              exit 1
            fi
          done

          echo "âœ… All JSON files are valid"

  # ============================================================
  # Schema compatibility check
  # ============================================================
  compatibility:
    name: ðŸ”„ Backwards Compatibility
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: osss-validator/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: |
          cd osss-validator
          npm ci
          npm link

      - name: ðŸ”„ Test v1 compatibility
        run: |
          echo "ðŸ” Testing backwards compatibility with v1 instances..."

          # All existing examples should still validate
          # This ensures v2 schemas remain backwards compatible
          osss-validate bundle \
            --examples ./examples \
            --schemas ./schemas \
            --registry ./registry

          echo "âœ… All v1 instances validate with v2 schemas"

      - name: ðŸ“Š Check constraint coverage
        run: |
          echo "ðŸ” Checking constraint coverage in examples..."

          # Extract all ruleIds used in examples
          USED_RULES=$(find examples -name "osss-instance.json" -exec jq -r '.constraints[]?.ruleId // .constraints[]?.rule // empty' {} \; 2>/dev/null | sort -u)

          # Extract all ruleIds in registry
          REGISTRY_RULES=$(jq -r '.constraints[].ruleId' registry/constraints.json | sort -u)

          USED_COUNT=$(echo "$USED_RULES" | grep -c . || echo 0)
          TOTAL_COUNT=$(echo "$REGISTRY_RULES" | grep -c . || echo 0)

          echo "Constraints used in examples: $USED_COUNT / $TOTAL_COUNT"
          echo ""
          echo "Used constraints:"
          echo "$USED_RULES" | sed 's/^/  - /'
