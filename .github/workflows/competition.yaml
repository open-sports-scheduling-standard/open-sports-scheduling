# ============================================================
# ðŸ† OSSS COMPETITION JUDGE
# ------------------------------------------------------------
# Judge-as-code for OSSS scheduling competitions.
#
# Responsibilities:
#  - Validate submissions
#  - Re-score results (anti-cheat)
#  - Enforce OSSS conformance
#  - Update leaderboards
#  - Issue verifiable badges
#
# TEST MODE:
#  - Set OSSS_TEST_MODE=true to:
#    â€¢ skip leaderboard commits
#    â€¢ skip badge commits
#    â€¢ still validate + comment on PR
# ============================================================

name: ðŸŸï¸ OSSS Competition Judge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "submissions/**.json"

concurrency:
  group: osss-competition-${{ github.event.pull_request.base.ref }}
  cancel-in-progress: false

jobs:
  judge:
    name: âš–ï¸ Validate, Score & Judge Submission
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: 20
      TRACK_DIR: instances
      SUBMISSION_DIR: submissions
      LEADERBOARD_DIR: leaderboard

      # ðŸ”§ Toggle this to "true" to test the workflow safely
      OSSS_TEST_MODE: true

    steps:
      # ------------------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # ------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2ï¸âƒ£ Setup Node.js
      # ------------------------------------------------------------
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # ------------------------------------------------------------
      # 3ï¸âƒ£ Install system dependencies
      # ------------------------------------------------------------
      - name: ðŸ§° Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ------------------------------------------------------------
      # 4ï¸âƒ£ Install OSSS Validator
      # ------------------------------------------------------------
      - name: ðŸ“¦ Install OSSS Validator
        run: |
          echo "ðŸ”§ Installing OSSS validator dependencies..."
          npm ci

      # ------------------------------------------------------------
      # 5ï¸âƒ£ Locate submission file (STRICT)
      # ------------------------------------------------------------
      - name: ðŸ” Locate submission file
        id: submission
        run: |
          set -e
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^submissions/.*\.json$' || true)
          COUNT=$(echo "$FILES" | wc -l)

          if [ "$COUNT" -ne 1 ]; then
            echo "âŒ Exactly ONE submission JSON must be modified per PR."
            echo "$FILES"
            exit 1
          fi

          FILE=$(echo "$FILES" | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "âœ… Submission: $FILE"

      # ------------------------------------------------------------
      # 6ï¸âƒ£ Parse submission metadata
      # ------------------------------------------------------------
      - name: ðŸ§¾ Parse submission metadata
        id: meta
        run: |
          set -e
          FILE="${{ steps.submission.outputs.file }}"

          TRACK=$(jq -r '.track' "$FILE")
          SOLVER=$(jq -r '.solver.name' "$FILE")

          if [ "$TRACK" = "null" ] || [ "$SOLVER" = "null" ]; then
            echo "âŒ Submission must include track and solver.name"
            exit 1
          fi

          INSTANCE="${TRACK_DIR}/${TRACK}.json"
          if [ ! -f "$INSTANCE" ]; then
            echo "âŒ Instance not found for track: $TRACK"
            exit 1
          fi

          echo "track=$TRACK" >> $GITHUB_OUTPUT
          echo "solver=$SOLVER" >> $GITHUB_OUTPUT
          echo "instance=$INSTANCE" >> $GITHUB_OUTPUT

          echo "ðŸ Track: $TRACK"
          echo "ðŸ¤– Solver: $SOLVER"

      # ------------------------------------------------------------
      # 7ï¸âƒ£ Validate & re-score (authoritative)
      # ------------------------------------------------------------
      - name: âš–ï¸ Run OSSS Validator (anti-cheat)
        id: validate
        run: |
          set -e
          FILE="${{ steps.submission.outputs.file }}"
          INSTANCE="${{ steps.meta.outputs.instance }}"

          echo "ðŸ§  Validating submission..."
          npx osss-validate result \
            --instance "$INSTANCE" \
            --result "$FILE" \
            --schemas schemas \
            --registry registry \
            --fix-scores \
            --out validated.json

          echo "âœ… Validation successful"

      # ------------------------------------------------------------
      # 8ï¸âƒ£ Capture validator version
      # ------------------------------------------------------------
      - name: ðŸ“Œ Capture validator version
        id: validator
        run: |
          VERSION=$(npx osss-validate --version || echo "unknown")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ§  Validator version: $VERSION"

      # ------------------------------------------------------------
      # 9ï¸âƒ£ Update leaderboard (skipped in test mode)
      # ------------------------------------------------------------
      - name: ðŸ† Update leaderboard
        if: success() && env.OSSS_TEST_MODE != 'true'
        run: |
          TRACK="${{ steps.meta.outputs.track }}"
          SOLVER="${{ steps.meta.outputs.solver }}"
          BOARD="${LEADERBOARD_DIR}/${TRACK}.json"

          node scripts/updateLeaderboard.js \
            --leaderboard "$BOARD" \
            --validated validated.json \
            --solver "$SOLVER"

      # ------------------------------------------------------------
      # ðŸ”– Prepare badge directory
      # ------------------------------------------------------------
      - name: ðŸ”– Prepare badge directory
        if: success() && env.OSSS_TEST_MODE != 'true'
        run: |
          mkdir -p badges/${{ steps.meta.outputs.solver }}/${{ steps.meta.outputs.track }}

      # ------------------------------------------------------------
      # ðŸŸ¢ OSSS Conformant badge
      # ------------------------------------------------------------
      - name: ðŸŸ¢ Issue OSSS Conformant badge
        if: success() && env.OSSS_TEST_MODE != 'true'
        run: |
          SOLVER="${{ steps.meta.outputs.solver }}"
          TRACK="${{ steps.meta.outputs.track }}"

          cat > badges/${SOLVER}/${TRACK}/osss-conformant.json <<EOF
          {
            "badge": "osss-conformant",
            "solver": "${SOLVER}",
            "track": "${TRACK}",
            "competition": "osss-2025",
            "issuedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "validatorVersion": "${{ steps.validator.outputs.version }}"
          }
          EOF

      # ------------------------------------------------------------
      # ðŸŸ£ OSSS Verified Scores badge
      # ------------------------------------------------------------
      - name: ðŸŸ£ Issue OSSS Verified Scores badge
        if: success() && env.OSSS_TEST_MODE != 'true'
        run: |
          SOLVER="${{ steps.meta.outputs.solver }}"
          TRACK="${{ steps.meta.outputs.track }}"

          cat > badges/${SOLVER}/${TRACK}/osss-verified-scores.json <<EOF
          {
            "badge": "osss-verified-scores",
            "solver": "${SOLVER}",
            "track": "${TRACK}",
            "competition": "osss-2025",
            "issuedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "validatorVersion": "${{ steps.validator.outputs.version }}",
            "instanceHash": "$(jq -r '._instanceHash' validated.json)",
            "rulesetHash": "$(jq -r '._rulesetHash' validated.json)",
            "resultHash": "$(jq -r '._resultHash' validated.json)"
          }
          EOF

      # ------------------------------------------------------------
      # ðŸ’¾ Commit leaderboard & badges (skipped in test mode)
      # ------------------------------------------------------------
      - name: ðŸ’¾ Commit artifacts
        if: success() && env.OSSS_TEST_MODE != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ† OSSS Judge: update leaderboard & badges"
          file_pattern: |
            leaderboard/*.json
            badges/**
          commit_user_name: "OSSS Judge Bot"
          commit_user_email: "judge@opensportsscheduling.org"

      # ------------------------------------------------------------
      # ðŸ’¬ Comment on PR
      # ------------------------------------------------------------
      - name: ðŸ’¬ Comment on Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const result = JSON.parse(fs.readFileSync("validated.json", "utf8"));

            const penalty = result.scores.totalPenalty;
            const feasible = result.feasible ? "âœ… Feasible" : "âš ï¸ Infeasible";
            const testMode = process.env.OSSS_TEST_MODE === "true";

            const body = `
            ## ðŸŸï¸ OSSS Submission Judged

            **Solver:** \`${{ steps.meta.outputs.solver }}\`  
            **Track:** \`${{ steps.meta.outputs.track }}\`

            **Result:** ${feasible}  
            **Total Penalty:** **${penalty}**

            ðŸ”’ Scores recomputed by OSSS Validator  
            ðŸ§ª Test Mode: **${testMode ? "ON (no artifacts committed)" : "OFF"}**

            ${testMode ? "_This run did not update leaderboards or issue badges._" : "See leaderboard for ranking."}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      # ------------------------------------------------------------
      # ðŸ”š Final verdict
      # ------------------------------------------------------------
      - name: ðŸŽ‰ Verdict
        run: |
          echo "ðŸ OSSS Judge complete."
          echo "Test mode: $OSSS_TEST_MODE"
