{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://opensportsscheduling.org/schemas/osss-core.schema.json",
  "title": "OSSS Core Schema",
  "description": "Open Sports Scheduling Standard v2.0 - Core instance schema",
  "type": "object",
  "required": ["id", "name", "timezone", "season", "entities", "fixtures"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for the OSSS instance"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for this scheduling instance"
    },
    "description": {
      "type": "string",
      "description": "Detailed description of this scheduling problem"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "OSSS schema version (semver format)",
      "default": "2.0.0"
    },
    "sport": {
      "type": "string",
      "description": "Sport type (e.g., 'soccer', 'basketball', 'american_football')"
    },
    "timezone": {
      "type": "string",
      "description": "IANA timezone (e.g. America/New_York) or UTC"
    },
    "season": {
      "type": "object",
      "required": ["start", "end"],
      "properties": {
        "start": { "type": "string", "description": "Season start date (YYYY-MM-DD or ISO 8601)" },
        "end": { "type": "string", "description": "Season end date (YYYY-MM-DD or ISO 8601)" },
        "blackoutDates": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["start", "end"],
            "properties": {
              "start": { "type": "string" },
              "end": { "type": "string" },
              "reason": { "type": "string" }
            }
          }
        },
        "phases": {
          "type": "array",
          "items": { "$ref": "#/$defs/phase" }
        }
      }
    },
    "entities": { "$ref": "#/$defs/entities" },
    "fixtures": {
      "type": "array",
      "items": { "$ref": "#/$defs/fixture" },
      "minItems": 1
    },
    "constraints": {
      "type": "array",
      "items": { "$ref": "#/$defs/constraintRef" },
      "description": "Constraints for this instance (can also be in separate file)"
    },
    "objectives": {
      "type": "array",
      "items": { "$ref": "#/$defs/objectiveRef" },
      "description": "Objectives for this instance (can also be in separate file)"
    },
    "defaultFixtureDuration": {
      "type": "integer",
      "minimum": 1,
      "description": "Default duration in minutes for fixtures without durationMinutes"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "description": "Additional metadata (contributor, references, etc.)"
    }
  },

  "$defs": {
    "phase": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "startDate": { "type": "string" },
        "endDate": { "type": "string" },
        "description": { "type": "string" },
        "rounds": { "type": "integer", "minimum": 1 },
        "format": {
          "type": "string",
          "enum": ["round_robin", "double_round_robin", "triple_round_robin", "knockout", "swiss", "group", "playoff", "other"]
        },
        "dynamic": {
          "type": "boolean",
          "description": "Whether phase structure depends on prior results"
        },
        "dependsOnPhase": {
          "type": "string",
          "description": "Phase ID this phase depends on for participant resolution"
        }
      }
    },

    "entities": {
      "type": "object",
      "required": ["teams", "venues"],
      "properties": {
        "teams": {
          "type": "array",
          "items": { "$ref": "#/$defs/team" },
          "minItems": 2
        },
        "venues": {
          "type": "array",
          "items": { "$ref": "#/$defs/venue" },
          "minItems": 1
        },
        "officials": {
          "type": "array",
          "items": { "$ref": "#/$defs/official" }
        },
        "resources": {
          "type": "array",
          "items": { "$ref": "#/$defs/resource" },
          "description": "Venue sub-resources (courts, fields, etc.)"
        }
      }
    },

    "baseEntity": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "name": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Tags for constraint selectors"
        }
      }
    },

    "team": {
      "allOf": [
        { "$ref": "#/$defs/baseEntity" },
        {
          "type": "object",
          "properties": {
            "homeVenueId": {
              "type": "string",
              "description": "Primary home venue ID"
            },
            "alternateVenueIds": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Alternative venue IDs"
            },
            "division": { "type": "string" },
            "conference": { "type": "string" },
            "region": { "type": "string" },
            "strength": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Team strength rating (0-100) for carry-over calculations"
            },
            "ranking": {
              "type": "integer",
              "minimum": 1,
              "description": "Current ranking position"
            },
            "location": {
              "$ref": "#/$defs/geoLocation",
              "description": "Team location for travel calculations"
            }
          }
        }
      ]
    },

    "venue": {
      "allOf": [
        { "$ref": "#/$defs/baseEntity" },
        {
          "type": "object",
          "properties": {
            "capacity": {
              "type": "integer",
              "minimum": 0
            },
            "location": { "$ref": "#/$defs/geoLocation" },
            "timezone": {
              "type": "string",
              "description": "Venue timezone if different from instance timezone"
            },
            "surface": {
              "type": "string",
              "description": "Playing surface type"
            },
            "roofed": {
              "type": "boolean",
              "description": "Whether venue has retractable/permanent roof"
            },
            "availability": {
              "oneOf": [
                { "type": "array", "items": { "$ref": "#/$defs/availabilityWindow" } },
                { "type": "object", "additionalProperties": true }
              ],
              "description": "Availability windows (array or object format)"
            },
            "changeoverMinutes": {
              "type": "integer",
              "minimum": 0,
              "description": "Minimum time between fixtures at this venue"
            }
          }
        }
      ]
    },

    "geoLocation": {
      "type": "object",
      "properties": {
        "lat": {
          "type": "number",
          "description": "Latitude in degrees"
        },
        "lon": {
          "type": "number",
          "description": "Longitude in degrees"
        },
        "latitude": { "type": "number" },
        "longitude": { "type": "number" },
        "city": { "type": "string" },
        "country": { "type": "string" }
      },
      "additionalProperties": true
    },

    "availabilityWindow": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "start": { "type": "string" },
        "end": { "type": "string" },
        "dayOfWeek": { "type": "string" },
        "daysOfWeek": {
          "oneOf": [
            { "type": "array", "items": { "type": "integer" } },
            { "type": "array", "items": { "type": "string" } }
          ]
        },
        "startTime": { "type": "string" },
        "endTime": { "type": "string" },
        "recurring": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },

    "official": {
      "allOf": [
        { "$ref": "#/$defs/baseEntity" },
        {
          "type": "object",
          "properties": {
            "qualificationLevel": {
              "type": "string",
              "enum": ["trainee", "local", "regional", "national", "international", "elite"],
              "description": "Official certification level"
            },
            "roles": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["referee", "umpire", "linesman", "fourth_official", "var", "scorer", "timekeeper"]
              }
            },
            "availability": {
              "oneOf": [
                { "type": "array", "items": { "$ref": "#/$defs/availabilityWindow" } },
                { "type": "object", "additionalProperties": true }
              ],
              "description": "Availability windows (array or object format)"
            },
            "conflictTeamIds": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Teams this official cannot officiate (conflict of interest)"
            },
            "location": { "$ref": "#/$defs/geoLocation" }
          }
        }
      ]
    },

    "resource": {
      "allOf": [
        { "$ref": "#/$defs/baseEntity" },
        {
          "type": "object",
          "required": ["venueId", "type"],
          "properties": {
            "venueId": {
              "type": "string",
              "description": "Parent venue ID"
            },
            "type": {
              "type": "string",
              "enum": ["field", "court", "pitch", "arena", "track", "pool", "rink", "ring", "other"]
            },
            "surface": { "type": "string" },
            "capacity": { "type": "integer", "minimum": 0 },
            "suitableFor": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Sports this resource supports"
            },
            "availability": {
              "oneOf": [
                { "type": "array", "items": { "$ref": "#/$defs/availabilityWindow" } },
                { "type": "object", "additionalProperties": true }
              ],
              "description": "Availability windows (array or object format)"
            },
            "changeoverMinutes": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      ]
    },

    "fixture": {
      "type": "object",
      "required": ["id", "participants"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "participants": {
          "type": "array",
          "minItems": 2,
          "items": { "$ref": "#/$defs/participant" }
        },
        "durationMinutes": {
          "type": "integer",
          "minimum": 1,
          "description": "Fixture duration. Uses defaultFixtureDuration if not specified."
        },
        "phase": {
          "type": "string",
          "description": "Phase ID this fixture belongs to"
        },
        "round": {
          "oneOf": [
            { "type": "integer", "minimum": 1 },
            { "type": "string" }
          ]
        },
        "group": { "type": "string" },
        "matchday": { "type": "integer", "minimum": 1 },
        "dependsOn": {
          "type": "array",
          "items": { "$ref": "#/$defs/fixtureDependency" },
          "description": "Fixtures this fixture depends on (for knockouts)"
        },
        "conditional": {
          "oneOf": [
            { "type": "boolean" },
            { "$ref": "#/$defs/conditionalDef" }
          ],
          "description": "Whether fixture is conditional on prior results"
        },
        "locked": {
          "type": "boolean",
          "default": false,
          "description": "If true, fixture time/venue is pre-assigned and cannot change"
        },
        "lockedStartTime": {
          "type": "string",
          "description": "Pre-assigned start time (when locked=true)"
        },
        "lockedVenueId": {
          "type": "string",
          "description": "Pre-assigned venue (when locked=true)"
        },
        "priority": {
          "oneOf": [
            { "type": "number" },
            { "type": "string" }
          ],
          "description": "Scheduling priority (number or string)"
        },
        "requiredOfficialLevel": {
          "type": "string",
          "description": "Minimum official qualification required"
        },
        "broadcastRequired": {
          "type": "boolean",
          "description": "Whether this fixture requires broadcast slot"
        }
      }
    },

    "participant": {
      "oneOf": [
        { "type": "string" },
        {
          "type": "object",
          "required": ["id"],
          "properties": {
            "id": { "type": "string" },
            "role": {
              "type": "string",
              "enum": ["home", "away", "neutral", "participant"],
              "default": "participant"
            }
          }
        }
      ]
    },

    "fixtureDependency": {
      "type": "object",
      "required": ["fixtureId", "participantFrom"],
      "properties": {
        "fixtureId": {
          "type": "string",
          "description": "ID of fixture this depends on"
        },
        "participantFrom": {
          "type": "string",
          "enum": ["winner", "loser", "1st", "2nd", "3rd", "4th", "home", "away"],
          "description": "Which result from the dependency determines the participant"
        }
      }
    },

    "conditionalDef": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "type": { "type": "string" },
        "group": { "type": "string" },
        "phase": { "type": "string" },
        "condition": { "type": "string" },
        "dependsOn": { "type": "string" }
      }
    },

    "constraintRef": {
      "type": "object",
      "required": ["id", "type"],
      "properties": {
        "id": { "type": "string" },
        "ruleId": {
          "type": "string",
          "description": "Reference to constraint rule in registry (v2 format)"
        },
        "rule": {
          "type": "string",
          "description": "Reference to constraint rule (v1 format, use ruleId for v2)"
        },
        "type": {
          "type": "string",
          "enum": ["hard", "soft"]
        },
        "params": {
          "type": "object",
          "additionalProperties": true
        },
        "selector": { "$ref": "#/$defs/selector" },
        "penalty": {
          "oneOf": [
            { "type": "number", "minimum": 0 },
            { "type": "object", "additionalProperties": true }
          ],
          "description": "Penalty value (number) or model (object)"
        },
        "description": { "type": "string" }
      }
    },

    "objectiveRef": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "metricId": {
          "type": "string",
          "description": "Reference to objective metric in registry (v2 format)"
        },
        "metric": {
          "type": "string",
          "description": "Reference to objective metric (v1 format, use metricId for v2)"
        },
        "direction": {
          "type": "string",
          "enum": ["minimize", "maximize", "balance"]
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "default": 1
        },
        "params": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },

    "selector": {
      "type": "object",
      "properties": {
        "entityType": {
          "type": "string",
          "enum": ["team", "venue", "fixture", "official", "resource", "phase"]
        },
        "ids": {
          "type": "array",
          "items": { "type": "string" }
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "phases": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Limit to specific phases"
        },
        "excludeIds": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Explicitly exclude these IDs"
        }
      }
    }
  }
}
